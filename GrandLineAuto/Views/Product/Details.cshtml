@model GrandLineAuto.Infrastructure.DTO_s.ProductDTO

@{
    ViewData["Title"] = Model.Name;

    (string Key, string Value)? ParseSpec(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return null;

        var idx = s.IndexOf(':');
        if (idx > 0 && idx < s.Length - 1)
        {
            var k = s.Substring(0, idx).Trim();
            var v = s.Substring(idx + 1).Trim();
            if (!string.IsNullOrWhiteSpace(k) && !string.IsNullOrWhiteSpace(v))
                return (k, v);
        }

        return ("Информация", s.Trim());
    }

    var specsRaw = new[]
    {
        Model.SpecificInfo1, Model.SpecificInfo2, Model.SpecificInfo3,
        Model.SpecificInfo4, Model.SpecificInfo5, Model.SpecificInfo6
    };

    var specs = specsRaw
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .Select(ParseSpec)
        .Where(x => x != null)
        .Select(x => x!.Value)
        .ToList();

    var oldPrice = Model.Price > 0 ? Math.Round(Model.Price * 1.25m, 2) : 0;
    var discountPercent = Model.Price > 0 ? (int)Math.Round((1 - (Model.Price / oldPrice)) * 100) : 0;

    var eur = Model.Price > 0 ? Math.Round(Model.Price / 1.95583m, 2) : 0;
}



<div class="container py-4">

    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Начало</a></li>
            <li class="breadcrumb-item">
                <a asp-controller="Categories" asp-action="Details" asp-route-id="@Model.SubCategoryId">Категория</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

  
    <div class="row g-4 align-items-start">

     
        <div class="col-12 col-lg-6">
            <div class="product-hero-card p-3 p-md-4">
                <div class="product-image-wrap">
                    <img src="@Model.ImageUrl" alt="@Model.Name" />
                </div>

                <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                    <span class="meta-pill">#@Model.Id.ToString().Substring(0, 8)</span>
                    <span class="meta-pill">Снимката е примерна</span>
                </div>
            </div>
        </div>


        <div class="col-12 col-lg-6">
            <div class="product-hero-card p-3 p-md-4">

                <div class="d-flex justify-content-between gap-3">
                    <div>
                        <h1 class="h4 mb-1">@Model.Name</h1>

                        <div class="text-muted mb-2">
                            парт номер:
                            <span class="fw-semibold">
                                @(specsRaw.FirstOrDefault(x => !string.IsNullOrWhiteSpace(x)) ?? Model.Id.ToString())
                            </span>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="text-warning" style="letter-spacing:1px;">★★★★☆</div>
                            <a href="#reviews" class="small text-decoration-none text-muted">оценете</a>
                        </div>
                    </div>

                    <div class="text-end">
                        @if (discountPercent > 0)
                        {
                            <span class="badge-discount">-@discountPercent%</span>
                        }
                    </div>
                </div>

                <hr class="my-3" />

                <div class="d-flex align-items-end justify-content-between flex-wrap gap-3">
                    <div>
                        @if (oldPrice > Model.Price && Model.Price > 0)
                        {
                            <div class="text-muted text-decoration-line-through">
                                @oldPrice.ToString("0.00") лв.
                            </div>
                        }

                        <div class="price-big fw-bold">
                            @Model.Price.ToString("0.00") лв.
                        </div>

                        @if (eur > 0)
                        {
                            <div class="text-muted small mt-1">
                                @eur.ToString("0.00") € <span class="ms-2">цена с ДДС</span>
                            </div>
                        }

                        @if (oldPrice > Model.Price && Model.Price > 0)
                        {
                            var save = Math.Round(oldPrice - Model.Price, 2);
                            <div class="small text-success mt-2">
                                спестявате: @save.ToString("0.00") лв.
                            </div>
                        }
                    </div>

                    <div class="text-end small text-muted">
                        <div>Наличност: <span class="text-success fw-semibold">в наличност</span></div>
                        <div>Доставка: 1–2 работни дни</div>
                    </div>
                </div>

                <hr class="my-3" />

              
                <div class="d-flex flex-column flex-sm-row align-items-stretch gap-3">
                    <div class="qty-pill">
                        <button type="button" id="btnMinus" aria-label="Decrease">−</button>
                        <input type="text" id="qtyInput" value="1" inputmode="numeric" />
                        <button type="button" id="btnPlus" aria-label="Increase">+</button>
                    </div>

                    <form asp-controller="Cart" asp-action="Add" method="post" class="flex-grow-1">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <input type="hidden" name="quantity" id="qtyHidden" value="1" />

                        <button type="submit" class="btn-add-modern w-100">
                            <span class="me-2">🛒</span> ДОБАВИ В КОЛИЧКАТА
                        </button>
                    </form>
                </div>

                <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
                    <a href="#" class="meta-pill text-decoration-none">
                        <span style="font-size:16px;">♡</span> Любими
                    </a>
                    <span class="meta-pill">Купи на кредит: tbi / UniCredit (визуално)</span>
                </div>

            </div>
        </div>
    </div>

    
    <div class="row mt-4">
        <div class="col-12">
            <div class="gl-tabs" id="productTabs">
                <div class="gl-tabs__nav" role="tablist" aria-label="Product tabs">
                    <button class="gl-tab is-active" type="button" role="tab" aria-selected="true" data-tab="desc">
                        Описание
                    </button>
                    <button class="gl-tab" type="button" role="tab" aria-selected="false" data-tab="specs">
                        Характеристики
                    </button>
                </div>

                <div class="gl-tabs__body">
                    <div class="gl-tabpanel is-active" id="desc" role="tabpanel">
                        <div class="gl-muted" style="white-space:pre-line;">
                            @Model.Description
                        </div>
                    </div>

                    <div class="gl-tabpanel" id="specs" role="tabpanel">
                        @if (specs.Any())
                        {
                            <div class="gl-spec-table">
                                @foreach (var (key, value) in specs)
                                {
                                    <div class="gl-spec-row">
                                        <div class="gl-spec-k">@key</div>
                                        <div class="gl-spec-v">@value</div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="gl-muted">Няма добавени характеристики за този продукт.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        (function () {
            const qtyInput = document.getElementById('qtyInput');
            const qtyHidden = document.getElementById('qtyHidden');
            const minus = document.getElementById('btnMinus');
            const plus = document.getElementById('btnPlus');

            function clampQty(v) {
                v = parseInt(v, 10);
                if (isNaN(v) || v < 1) v = 1;
                if (v > 99) v = 99;
                return v;
            }

            function sync() {
                const v = clampQty(qtyInput.value);
                qtyInput.value = v;
                qtyHidden.value = v;
                minus.disabled = v <= 1;
            }

            minus.addEventListener('click', () => { qtyInput.value = clampQty(qtyInput.value) - 1; sync(); });
            plus.addEventListener('click', () => { qtyInput.value = clampQty(qtyInput.value) + 1; sync(); });
            qtyInput.addEventListener('input', sync);
            sync();
        })();
    </script>

    <script>
        (function () {
            const root = document.getElementById('productTabs');
            if (!root) return;

            const tabs = root.querySelectorAll('.gl-tab');
            const panels = root.querySelectorAll('.gl-tabpanel');

            function activate(name) {
                tabs.forEach(t => {
                    const on = t.dataset.tab === name;
                    t.classList.toggle('is-active', on);
                    t.setAttribute('aria-selected', on ? 'true' : 'false');
                });

                panels.forEach(p => p.classList.toggle('is-active', p.id === name));
            }

            tabs.forEach(t => t.addEventListener('click', () => activate(t.dataset.tab)));
            activate('desc');
        })();
    </script>
}


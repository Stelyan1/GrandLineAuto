@model GrandLineAuto.Infrastructure.DTO_s.ProductDTO

@{
    ViewData["Title"] = Model.Name;

    (string Key, string Value)? ParseSpec(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return null;

        var idx = s.IndexOf(':');
        if (idx > 0 && idx < s.Length - 1)
        {
            var k = s.Substring(0, idx).Trim();
            var v = s.Substring(idx + 1).Trim();
            if (!string.IsNullOrWhiteSpace(k) && !string.IsNullOrWhiteSpace(v))
                return (k, v);
        }

        return ("Информация", s.Trim());
    }

    var specsRaw = new[]
    {
        Model.SpecificInfo1, Model.SpecificInfo2, Model.SpecificInfo3,
        Model.SpecificInfo4, Model.SpecificInfo5, Model.SpecificInfo6
    };

    var specs = specsRaw
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .Select(ParseSpec)
        .Where(x => x != null)
        .Select(x => x!.Value)
        .ToList();

    var oldPrice = Model.Price > 0 ? Math.Round(Model.Price * 1.25m, 2) : 0;
    var discountPercent = Model.Price > 0 ? (int)Math.Round((1 - (Model.Price / oldPrice)) * 100) : 0;

    var eur = Model.Price > 0 ? Math.Round(Model.Price / 1.95583m, 2) : 0;
}

<style>
    .product-hero-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 18px;
        box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }

    .product-image-wrap {
        background: #f6f7f9;
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,.06);
        overflow: hidden;
        display: grid;
        place-items: center;
        min-height: 360px;
    }

        .product-image-wrap img {
            max-height: 340px;
            width: 100%;
            object-fit: contain;
            padding: 18px;
            transition: transform .25s ease;
        }

        .product-image-wrap:hover img {
            transform: scale(1.02);
        }

    .price-big {
        font-size: clamp(28px, 3.2vw, 44px);
        line-height: 1.05;
        letter-spacing: -0.6px;
    }

    .badge-discount {
        background: rgba(220,53,69,.10);
        color: #dc3545;
        border: 1px solid rgba(220,53,69,.22);
        border-radius: 999px;
        padding: 8px 12px;
        font-weight: 700;
        font-size: 12px;
    }

    .qty-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.10);
        background: #fff;
        box-shadow: 0 8px 18px rgba(0,0,0,.05);
    }

        .qty-pill button {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.12);
            background: #fff;
            font-weight: 700;
        }

            .qty-pill button:hover {
                background: #f6f7f9;
            }

        .qty-pill input {
            width: 54px;
            text-align: center;
            border: 0;
            outline: none;
            font-weight: 700;
            background: transparent;
        }

    .btn-add-modern {
        border: 0;
        border-radius: 14px;
        padding: 14px 16px;
        font-weight: 800;
        letter-spacing: .3px;
        color: #fff;
        background: linear-gradient(135deg, #ff3b30, #d91e36);
        box-shadow: 0 14px 28px rgba(217,30,54,.25);
        transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }

        .btn-add-modern:hover {
            transform: translateY(-1px);
            filter: brightness(1.02);
            box-shadow: 0 18px 34px rgba(217,30,54,.30);
        }

        .btn-add-modern:active {
            transform: translateY(0);
        }

    .meta-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.08);
        background: #fff;
        color: #6c757d;
        font-size: 13px;
    }

    .tabs-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 10px 24px rgba(0,0,0,.05);
        background: #fff;
    }

        .tabs-card .nav-tabs {
            padding: 10px 12px;
            background: #fbfbfc;
            border-bottom: 1px solid rgba(0,0,0,.06);
        }

            .tabs-card .nav-tabs .nav-link {
                border: 0;
                border-radius: 999px;
                padding: 10px 14px;
                color: #495057;
                font-weight: 700;
            }

                .tabs-card .nav-tabs .nav-link.active {
                    background: #111827;
                    color: #fff;
                }

    .spec-table td, .spec-table th {
        padding: 12px 10px;
    }
</style>

<div class="container py-4">

    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Начало</a></li>
            <li class="breadcrumb-item">
                <a asp-controller="Categories" asp-action="Details" asp-route-id="@Model.SubCategoryId">Категория</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

  
    <div class="row g-4 align-items-start">

     
        <div class="col-12 col-lg-6">
            <div class="product-hero-card p-3 p-md-4">
                <div class="product-image-wrap">
                    <img src="@Model.ImageUrl" alt="@Model.Name" />
                </div>

                <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                    <span class="meta-pill">#@Model.Id.ToString().Substring(0, 8)</span>
                    <span class="meta-pill">Снимката е примерна</span>
                </div>
            </div>
        </div>


        <div class="col-12 col-lg-6">
            <div class="product-hero-card p-3 p-md-4">

                <div class="d-flex justify-content-between gap-3">
                    <div>
                        <h1 class="h4 mb-1">@Model.Name</h1>

                        <div class="text-muted mb-2">
                            парт номер:
                            <span class="fw-semibold">
                                @(specsRaw.FirstOrDefault(x => !string.IsNullOrWhiteSpace(x)) ?? Model.Id.ToString())
                            </span>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="text-warning" style="letter-spacing:1px;">★★★★☆</div>
                            <a href="#reviews" class="small text-decoration-none text-muted">оценете</a>
                        </div>
                    </div>

                    <div class="text-end">
                        @if (discountPercent > 0)
                        {
                            <span class="badge-discount">-@discountPercent%</span>
                        }
                    </div>
                </div>

                <hr class="my-3" />

                <div class="d-flex align-items-end justify-content-between flex-wrap gap-3">
                    <div>
                        @if (oldPrice > Model.Price && Model.Price > 0)
                        {
                            <div class="text-muted text-decoration-line-through">
                                @oldPrice.ToString("0.00") лв.
                            </div>
                        }

                        <div class="price-big fw-bold">
                            @Model.Price.ToString("0.00") лв.
                        </div>

                        @if (eur > 0)
                        {
                            <div class="text-muted small mt-1">
                                @eur.ToString("0.00") € <span class="ms-2">цена с ДДС</span>
                            </div>
                        }

                        @if (oldPrice > Model.Price && Model.Price > 0)
                        {
                            var save = Math.Round(oldPrice - Model.Price, 2);
                            <div class="small text-success mt-2">
                                спестявате: @save.ToString("0.00") лв.
                            </div>
                        }
                    </div>

                    <div class="text-end small text-muted">
                        <div>Наличност: <span class="text-success fw-semibold">в наличност</span></div>
                        <div>Доставка: 1–2 работни дни</div>
                    </div>
                </div>

                <hr class="my-3" />

              
                <div class="d-flex flex-column flex-sm-row align-items-stretch gap-3">
                    <div class="qty-pill">
                        <button type="button" id="btnMinus" aria-label="Decrease">−</button>
                        <input type="text" id="qtyInput" value="1" inputmode="numeric" />
                        <button type="button" id="btnPlus" aria-label="Increase">+</button>
                    </div>

                    <form asp-controller="Cart" asp-action="Add" method="post" class="flex-grow-1">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <input type="hidden" name="quantity" id="qtyHidden" value="1" />

                        <button type="submit" class="btn-add-modern w-100">
                            <span class="me-2">🛒</span> ДОБАВИ В КОЛИЧКАТА
                        </button>
                    </form>
                </div>

                <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
                    <a href="#" class="meta-pill text-decoration-none">
                        <span style="font-size:16px;">♡</span> Любими
                    </a>
                    <span class="meta-pill">Купи на кредит: tbi / UniCredit (визуално)</span>
                </div>

            </div>
        </div>
    </div>

    
    <div class="row mt-4">
        <div class="col-12">
            <div class="tabs-card">
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc"
                                type="button" role="tab" aria-controls="desc" aria-selected="true">
                            Описание
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs"
                                type="button" role="tab" aria-controls="specs" aria-selected="false">
                            Характеристики
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-3 p-md-4" id="productTabsContent">
                    <div class="tab-pane fade show active" id="desc" role="tabpanel" aria-labelledby="desc-tab">
                        <div class="text-muted" style="white-space:pre-line;">
                            @Model.Description
                        </div>
                    </div>

                    <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                        @if (specs.Any())
                        {
                            <div class="table-responsive">
                                <table class="table align-middle spec-table mb-0">
                                    <tbody>
                                        @foreach (var (key, value) in specs)
                                        {
                                            <tr>
                                                <th class="text-muted fw-semibold" style="width:42%;">@key</th>
                                                <td class="fw-semibold">@value</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-muted">Няма добавени характеристики за този продукт.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        (function () {
            const qtyInput = document.getElementById('qtyInput');
            const qtyHidden = document.getElementById('qtyHidden');
            const minus = document.getElementById('btnMinus');
            const plus = document.getElementById('btnPlus');

            function clampQty(v) {
                v = parseInt(v, 10);
                if (isNaN(v) || v < 1) v = 1;
                if (v > 99) v = 99;
                return v;
            }

            function sync() {
                const v = clampQty(qtyInput.value);
                qtyInput.value = v;
                qtyHidden.value = v;
                minus.disabled = v <= 1;
            }

            minus.addEventListener('click', () => { qtyInput.value = clampQty(qtyInput.value) - 1; sync(); });
            plus.addEventListener('click', () => { qtyInput.value = clampQty(qtyInput.value) + 1; sync(); });
            qtyInput.addEventListener('input', sync);
            sync();
        })();
    </script>
}

